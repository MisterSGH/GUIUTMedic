package guiutmedic.formularios;

import com.raven.event.EventTimePicker;
import java.awt.event.ItemEvent;
import java.awt.event.ItemListener;
import com.toedter.calendar.JDateChooser;
import guiutmedic.clases.Cita;
import guiutmedic.clases.CitaBD;
import guiutmedic.clases.ConexionBD;
import guiutmedic.clases.PerfilBD;
import guiutmedic.clases.PersonalSalud;
import guiutmedic.clases.PersonalSaludBD;
import guiutmedic.clases.Usuario;
import java.awt.Component;
import java.awt.Container;
import java.sql.Connection;
import java.sql.SQLException;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.List;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.JButton;
import javax.swing.JOptionPane;
import javax.swing.SwingUtilities;


/**
 *
 * @author santi
 */
public class frmAgendar extends javax.swing.JInternalFrame {

    /**
     * Creates new form frmAgendar
     */
    
    ConexionBD objetoConexionBD = new ConexionBD();
    Connection conn;

    PersonalSaludBD bd = new PersonalSaludBD();
    List<PersonalSalud> lista = bd.obtenerTodosPersonal();
            
    String fechaMSQL="//";
   
    
    
    private Usuario objetoMenuP; //variable del objeto local
    public frmAgendar(Usuario objUsuario) throws ClassNotFoundException{
        initComponents();
        this.objetoMenuP = objUsuario;

        quitarBotonesTimePicker();
        llenarEspecialista();
        
        
        cboEspecialista.addItemListener(new ItemListener() {
    public void itemStateChanged(ItemEvent e) {
        if (e.getStateChange() == ItemEvent.SELECTED) {
            String seleccionado = cboEspecialista.getSelectedItem().toString();
            cboMotivo.removeAllItems();
            
            if (seleccionado.contains("Médico")) {
                
                cboMotivo.addItem("1 - Consulta general");
                cboMotivo.addItem("2 - Síntomas gripales o fiebre");
                cboMotivo.addItem("3 - Dolor muscular o de cabeza");
                cboMotivo.addItem("4 - Lesión leve o accidente");
                cboMotivo.addItem("5 - Control de signos vitales");
                cboMotivo.addItem("6 - Malestar estomacal");
                // ...añadir más
            } else if (seleccionado.contains("Psicólogo")) {
                cboMotivo.addItem("7 - Primera consulta psicológica");
                cboMotivo.addItem("8 - Ansiedad o estrés académico");
                cboMotivo.addItem("9 - Depresión");
                cboMotivo.addItem("10 - Problemas personales");
                cboMotivo.addItem("11 - Crisis emocional");
                cboMotivo.addItem("12 - Dificultad para concentrarse");
                cboMotivo.addItem("13 - Terapia breve individual");
                // ...añadir más
            } else if (seleccionado.contains("Nutricionista")) {
                cboMotivo.addItem("14 - Primera consulta nutricional");
                cboMotivo.addItem("15 - Plan de alimentación");
                cboMotivo.addItem("16 - Control de peso");
                cboMotivo.addItem("17 - Control de enfermedades crónicas");
                cboMotivo.addItem("18 - Trastornos alimenticios");
                cboMotivo.addItem("19 - Seguimiento nutricional");
                // ...añadir más
            }
        }
    }
});
        
    }

    
    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        btnAgendarCita = new javax.swing.JButton();
        jPanel1 = new javax.swing.JPanel();
        lblFecha = new javax.swing.JLabel();
        cldFecha = new com.toedter.calendar.JCalendar();
        txtFecha = new javax.swing.JTextField();
        jPanel2 = new javax.swing.JPanel();
        lblHora = new javax.swing.JLabel();
        timePicker1 = new com.raven.swing.TimePicker();
        txtHora = new javax.swing.JTextField();
        jToggleButton1 = new javax.swing.JToggleButton();
        jPanel3 = new javax.swing.JPanel();
        lblMotivo = new javax.swing.JLabel();
        lblEspecialista = new javax.swing.JLabel();
        cboEspecialista = new javax.swing.JComboBox<>();
        cboMotivo = new javax.swing.JComboBox<>();

        setClosable(true);
        setTitle("Agendar cita");

        btnAgendarCita.setText("Agendar Cita");
        btnAgendarCita.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnAgendarCitaActionPerformed(evt);
            }
        });

        jPanel1.setBorder(javax.swing.BorderFactory.createTitledBorder("Fecha"));

        lblFecha.setText("Fecha:");

        cldFecha.addPropertyChangeListener(new java.beans.PropertyChangeListener() {
            public void propertyChange(java.beans.PropertyChangeEvent evt) {
                cldFechaPropertyChange(evt);
            }
        });

        txtFecha.setText("-Fecha-");

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel1Layout.createSequentialGroup()
                        .addComponent(lblFecha)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addComponent(txtFecha, javax.swing.GroupLayout.PREFERRED_SIZE, 92, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addComponent(cldFecha, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(0, 0, Short.MAX_VALUE))))
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addComponent(cldFecha, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(txtFecha, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(lblFecha))
                .addContainerGap())
        );

        jPanel2.setBorder(javax.swing.BorderFactory.createTitledBorder("Hora"));

        lblHora.setText("Hora:");

        timePicker1.setForeground(new java.awt.Color(0, 153, 153));
        timePicker1.set24hourMode(false);
        timePicker1.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                timePicker1MouseClicked(evt);
            }
        });
        timePicker1.addPropertyChangeListener(new java.beans.PropertyChangeListener() {
            public void propertyChange(java.beans.PropertyChangeEvent evt) {
                timePicker1PropertyChange(evt);
            }
        });

        txtHora.setText("-Fecha-");

        jToggleButton1.setText("Guardar");
        jToggleButton1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jToggleButton1ActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel2Layout = new javax.swing.GroupLayout(jPanel2);
        jPanel2.setLayout(jPanel2Layout);
        jPanel2Layout.setHorizontalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                    .addGroup(jPanel2Layout.createSequentialGroup()
                        .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addComponent(lblHora)
                        .addGap(13, 13, 13)
                        .addComponent(jToggleButton1)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(txtHora, javax.swing.GroupLayout.PREFERRED_SIZE, 118, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addGroup(javax.swing.GroupLayout.Alignment.LEADING, jPanel2Layout.createSequentialGroup()
                        .addContainerGap()
                        .addComponent(timePicker1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        jPanel2Layout.setVerticalGroup(
            jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel2Layout.createSequentialGroup()
                .addComponent(timePicker1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblHora)
                    .addComponent(txtHora, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jToggleButton1))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        jPanel3.setBorder(javax.swing.BorderFactory.createTitledBorder(""));

        lblMotivo.setText("Motivo:");

        lblEspecialista.setText("Especialista:");

        cboEspecialista.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "-Seleccionar-" }));
        cboEspecialista.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cboEspecialistaActionPerformed(evt);
            }
        });

        cboMotivo.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "-Seleccionar-" }));
        cboMotivo.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                cboMotivoActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel3Layout = new javax.swing.GroupLayout(jPanel3);
        jPanel3.setLayout(jPanel3Layout);
        jPanel3Layout.setHorizontalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel3Layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(jPanel3Layout.createSequentialGroup()
                        .addComponent(lblMotivo)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addComponent(cboMotivo, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addGroup(jPanel3Layout.createSequentialGroup()
                        .addComponent(lblEspecialista)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addComponent(cboEspecialista, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addContainerGap())
        );
        jPanel3Layout.setVerticalGroup(
            jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel3Layout.createSequentialGroup()
                .addGap(7, 7, 7)
                .addGroup(jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblEspecialista)
                    .addComponent(cboEspecialista, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(jPanel3Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblMotivo)
                    .addComponent(cboMotivo, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(jPanel3, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addGroup(layout.createSequentialGroup()
                        .addGap(61, 61, 61)
                        .addComponent(btnAgendarCita)))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jPanel2, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jPanel2, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jPanel3, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(27, 27, 27)
                        .addComponent(btnAgendarCita)))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents
        

    
    private void llenarEspecialista() {

        System.out.println("Tamaño de la lista: " + lista.size());

        for (PersonalSalud p : lista) {
            System.out.println("Nombre: " + p.getNombre() + ", Profesión: " + p.getProfesion());
            cboEspecialista.addItem(p.getIdPersonal()+" - "+p.getNombre() + " - " + p.getProfesion());
        }
}
    
    private void btnAgendarCitaActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnAgendarCitaActionPerformed
        
        try {
            
            conn = objetoConexionBD.conexionDataBase();
            String fechaInput = txtFecha.getText(); // ej: "15/08/2025"
            SimpleDateFormat formatoEntrada = new SimpleDateFormat("dd/MM/yyyy");
            SimpleDateFormat formatoMySQL = new SimpleDateFormat("yyyy-MM-dd");

                Date fecha = formatoEntrada.parse(fechaInput); // convierte String a Date
                String fechaMySQL = formatoMySQL.format(fecha); // convierte Date a String en formato MySQL
                
            PerfilBD perfilDB = new PerfilBD();
            int idPerfil = perfilDB.obtenerIdPerfilPorIdUsuario(conn, objetoMenuP.getIdUsuario()); //metodo para obtener el idperfil del idusuario

            fechaMSQL=fechaMySQL;
            String hora = txtHora.getText();
            String[] partesE = cboEspecialista.getSelectedItem().toString().split(" - ");
            int numeroE = Integer.parseInt(partesE[0]);
            System.out.println(numeroE);
            String[] partesM = cboMotivo.getSelectedItem().toString().split(" - ");
            int numeroM = Integer.parseInt(partesM[0]);
            System.out.println(numeroM);
                        
            Cita cita = new Cita(idPerfil, numeroE, numeroM, fechaMSQL, hora, "", ""); //constructor de la cita
            
            CitaBD bd = new CitaBD();
            boolean exito = bd.registrarCita(conn, cita);
            if (exito) {
                JOptionPane.showMessageDialog(this, "Cita agendada correctamente.");
            } else {
                JOptionPane.showMessageDialog(this, "No se pudo agendar la cita. Verifica los datos.");
                }

        } catch (ClassNotFoundException ex) {
            Logger.getLogger(frmAgendar.class.getName()).log(Level.SEVERE, null, ex);
        } catch (SQLException ex) {
            Logger.getLogger(frmAgendar.class.getName()).log(Level.SEVERE, null, ex);
        } catch (ParseException ex) {
            Logger.getLogger(frmAgendar.class.getName()).log(Level.SEVERE, null, ex);
            JOptionPane.showMessageDialog(this, "Formato de fecha inválido. Use dd/MM/yyyy");
        }
    }//GEN-LAST:event_btnAgendarCitaActionPerformed

    private void cboEspecialistaActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cboEspecialistaActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_cboEspecialistaActionPerformed

    private void cboMotivoActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_cboMotivoActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_cboMotivoActionPerformed

    private void cldFechaPropertyChange(java.beans.PropertyChangeEvent evt) {//GEN-FIRST:event_cldFechaPropertyChange
        // TODO add your handling code here:
        
        if (evt.getOldValue() != null) {
            SimpleDateFormat ff = new SimpleDateFormat("dd/MM/yyyy");
            txtFecha.setText(ff.format(cldFecha.getCalendar().getTime()));
             SimpleDateFormat fSQL = new SimpleDateFormat("yyyy/MM/dd");
            fechaMSQL=fSQL.format(cldFecha.getCalendar().getTime());
        }
    }//GEN-LAST:event_cldFechaPropertyChange

    private void timePicker1PropertyChange(java.beans.PropertyChangeEvent evt) {//GEN-FIRST:event_timePicker1PropertyChange
        // TODO add your handling code here:
        if (evt.getOldValue() != null) {
            
            Date hora = timePicker1.getSelectedDate();
            System.out.println("hora: "+hora);
            SimpleDateFormat formatoHora = new SimpleDateFormat("HH:mm");
            String horaTexto = formatoHora.format(hora);

            txtHora.setText(horaTexto);
        }
    }//GEN-LAST:event_timePicker1PropertyChange

    public void addEventTimePicker(EventTimePicker event) {
        
    }
    
    private void timePicker1MouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_timePicker1MouseClicked
        // TODO add your handling code here:
        
    }//GEN-LAST:event_timePicker1MouseClicked

    private void jToggleButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jToggleButton1ActionPerformed
        // TODO add your handling code here:
        Date hora = timePicker1.getSelectedDate();
        System.out.println("hora: "+hora);
        SimpleDateFormat formatoHora = new SimpleDateFormat("HH:mm");
        String horaTexto = formatoHora.format(hora);
        System.out.println("h: "+horaTexto);
        txtHora.setText(horaTexto);
    }//GEN-LAST:event_jToggleButton1ActionPerformed

public void quitarBotonesTimePicker() {
    SwingUtilities.invokeLater(() -> {
        // Busca el popup del timePicker1
        for (Component comp : timePicker1.getComponents()) {
            ocultarBotonesRecursivo(comp);
        }
    });
}

private void ocultarBotonesRecursivo(Component comp) {
    if (comp instanceof JButton) {
        JButton btn = (JButton) comp;
        String texto = btn.getText().toLowerCase();
        if (texto.contains("ok") || texto.contains("cancel")) {
            btn.setVisible(false);
        }
    } else if (comp instanceof Container) {
        for (Component hijo : ((Container) comp).getComponents()) {
            ocultarBotonesRecursivo(hijo);
        }
    }
}
    
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnAgendarCita;
    private javax.swing.JComboBox<String> cboEspecialista;
    private javax.swing.JComboBox<String> cboMotivo;
    private com.toedter.calendar.JCalendar cldFecha;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JToggleButton jToggleButton1;
    private javax.swing.JLabel lblEspecialista;
    private javax.swing.JLabel lblFecha;
    private javax.swing.JLabel lblHora;
    private javax.swing.JLabel lblMotivo;
    private com.raven.swing.TimePicker timePicker1;
    private javax.swing.JTextField txtFecha;
    private javax.swing.JTextField txtHora;
    // End of variables declaration//GEN-END:variables
}
